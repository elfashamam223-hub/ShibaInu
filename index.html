<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shiba Inu Rewards</title>

  <!-- Monetag SDK (for rewarded popup) -->
  <script src='//libtl.com/sdk.js' data-zone='9682710' data-sdk='show_9682710'></script>

  <style>
    :root{
      --bg: #fff4e6;
      --card: #fff;
      --accent: #ff9900;
      --accent2: #ff3366;
      --text: #2b2b2b;
      --muted: #7a7a7a;
      --ring: rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px var(--ring);padding:20px}
    .logo{width:88px;height:88px;border-radius:50%;object-fit:cover;box-shadow:0 6px 16px var(--ring)}
    h1,h2,h3{margin:10px 0}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:720px){.grid-2{grid-template-columns:1fr}}
    input,button{font-size:16px}
    input{width:100%;padding:12px 14px;border:1px solid #ececec;border-radius:12px;outline:none}
    input:focus{border-color:#ffd6a8;box-shadow:0 0 0 4px #fff0e0}
    .btn{border:0;border-radius:12px;padding:12px 16px;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-danger{background:var(--accent2);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .section-title{display:flex;align-items:center;gap:8px}
    .pill{display:inline-block;padding:6px 10px;background:#fff6ec;border:1px solid #ffe3c2;border-radius:999px;font-size:12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .balance{font-size:22px;font-weight:700}
    .divider{height:1px;background:#f1e6d8;margin:8px 0 16px}

    /* fun mining banner */
    .mine{margin-top:8px;background:linear-gradient(135deg,#ffe0b2,#fff);border:1px solid #ffe3c2;border-radius:16px;padding:14px;position:relative;overflow:hidden}
    .mine:after{content:"";position:absolute;inset:-40px;opacity:.15;background:url('https://i.imgur.com/8r6mW8F.png') repeat;transform:rotate(6deg)}
    .ticker{height:8px;background:#ffe3c2;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0%;background:var(--accent);animation:mine 2.5s infinite}
    @keyframes mine{0%{width:0%}50%{width:85%}100%{width:0%}}

    .leader{padding:0;margin:0;list-style:none}
    .leader li{display:flex;justify-content:space-between;padding:10px 12px;border:1px solid #f3e6d6;border-radius:10px;margin-bottom:8px;background:#fff}

    .footer{display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:18px}
    .binance{width:120px;opacity:.9}
    .cta-row{display:flex;flex-wrap:wrap;gap:10px}

    .topline{display:flex;align-items:center;gap:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LOGIN PAGE -->
    <div id="login" class="card">
      <div class="topline">
        <img class="logo" src="https://i.pinimg.com/736x/2b/67/3a/2b673ae57cd8d2c4344945ea6c36bd17.jpg" alt="Shiba Inu"/>
        <div>
          <h2>Shiba Inu Rewards</h2>
          <div class="muted">Login to start mining & collecting SHIB</div>
        </div>
      </div>
      <div class="divider"></div>
      <form id="loginForm" class="grid">
        <input id="name" type="text" placeholder="Your Name" required />
        <input id="email" type="email" placeholder="Binance / FaucetPay Email" required />
        <button class="btn btn-primary" type="submit">Start</button>
      </form>
      <div class="muted" style="margin-top:8px;font-size:13px">We store your name, email, and balance in Google Sheets.</div>
    </div>

    <!-- DASHBOARD -->
    <div id="app" class="grid" style="display:none;margin-top:16px">
      <div class="card">
       <div class="row">
        <div style="display:flex;align-items:center;gap:12px">
         <img class="logo" src="https://i.pinimg.com/736x/2b/67/3a/2b673ae57cd8d2c4344945ea6c36bd17.jpg" alt="Shiba Inu"/>
         <div>
          <h2>Welcome, <span id="userName">Anon</span> üëã</h2>
          <div class="muted">One day $SHIB will hit $1...</div>
         </div>
        </div>
        <button id="logoutBtn" class="btn" title="Logout">Logout</button>
    </div> 
  <!-- Ganti mining status jadi tombol watch ads -->
  <div style="margin-top:14px; text-align:center;">
    <div class="balance">üí∞ <span id="balance">0</span> SHIB</div>
    <button id="watchBtn" class="btn btn-primary" style="margin-top:12px;">üì∫ Watch Ads (+8 SHIB)</button>
    <button id="refreshBtn" class="btn" style="margin-top:8px;">‚Üª Refresh Balance</button>
  </div>
</div>

      <div class="card">
        <div class="section-title"><h3>üèÜ Top 10 Earners</h3><span class="pill">live</span></div>
        <ol id="leaderboard" class="leader">
          <li class="muted" style="justify-content:center">Loading...</li>
        </ol>
      </div>

      <div class="card">
        <div class="section-title"><h3>üí∏ Withdraw</h3><span class="pill">min 120 SHIB</span></div>
        <form id="withdrawForm" class="grid">
          <div class="grid grid-2">
            <input id="w_name" type="text" placeholder="Your Name" required />
            <input id="w_email" type="email" placeholder="Binance / FaucetPay Email" required />
          </div>
          <input id="w_amount" type="number" min="120" placeholder="Amount (min 120)" required />
          <button class="btn btn-danger" type="submit">Request Withdraw</button>
        </form>
        <div class="footer">
          <img class="binance" src="https://apaysuksstorageprod.blob.core.windows.net/connectorimages/BinanceBanner.webp" alt="Binance"/>
          <div class="muted" style="font-size:13px">Withdrawals are reviewed by admin.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * CONFIG ‚Äî replace with your own
     */
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwDgYgy2UQjkbxUj6mh2NkRVFjYtRx381OVruYB2uIZ0PKCgm_sISYjU5Ul_IFA5-U/exec"; // e.g. https://script.google.com/macros/s/XXX/exec
    const SECRET_KEY = "Elfaidasany3";                 // must match in Apps Script

    /**
     * State
     */
    let currentUser = null; // { name, email }

    /**
     * Utils to call Apps Script
     */
    async function apiPost(payload){
      const res = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ secret: SECRET_KEY, ...payload })
      });
      return res.json().catch(()=>({}));
    }
    async function apiGet(params){
      const q = new URLSearchParams({ secret: SECRET_KEY, ...params });
      const res = await fetch(`${APPS_SCRIPT_URL}?${q.toString()}`);
      return res.json().catch(()=>({}));
    }

    /**
     * UI helpers
     */
    function show(el){ el.style.display='block'; }
    function hide(el){ el.style.display='none'; }
    function $(id){ return document.getElementById(id); }

    /**
     * Auth / Session
     */
    function saveSession(user){ localStorage.setItem('shib_user', JSON.stringify(user)); }
    function loadSession(){ try{ return JSON.parse(localStorage.getItem('shib_user')||'null'); }catch{return null} }
    function clearSession(){ localStorage.removeItem('shib_user'); }

    /**
     * Load Balance + Leaderboard
     */
    async function loadBalance(){
  if(!currentUser) return;
  // Ambil saldo dari localStorage, kalau ada
  const localBal = localStorage.getItem('shib_balance');
  if(localBal !== null){
    $('balance').textContent = localBal;
    return parseInt(localBal, 10);
  }
  // Kalau belum ada, tetap cek dari Sheet
  const data = await apiGet({ action:'get_balance', email: currentUser.email });
  const bal = (data && typeof data.balance !== 'undefined') ? data.balance : 0;
  $('balance').textContent = bal;
  return bal;
}

(async function boot(){
  const session = loadSession();
  if(session && session.email){
    currentUser = session;
    $('userName').textContent = session.name;
    hide($('login'));
    show($('app'));
    // Cek saldo dari localStorage dulu
    const localBal = localStorage.getItem('shib_balance');
    if(localBal !== null){
      $('balance').textContent = localBal;
    } else {
      await loadBalance();
    }
    await loadLeaderboard();
  }
})();

    async function loadLeaderboard(){
      const list = $('leaderboard');
      list.innerHTML = '<li class="muted" style="justify-content:center">Loading...</li>';
      const data = await apiGet({ action:'top10' });
      if(!Array.isArray(data) || !data.length){ list.innerHTML = '<li class="muted" style="justify-content:center">No data</li>'; return; }
      list.innerHTML = data.map((u,i)=>`<li><span>${i+1}. ${escapeHtml(u.name||'Anon')}</span><strong>${Number(u.balance||0)} SHIB</strong></li>`).join('');
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    }

    /**
     * Login flow
     */
    $('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = $('name').value.trim();
      const email = $('email').value.trim().toLowerCase();
      if(!name||!email) return;

      // Register (idempotent: create if not exists)
      try{ await apiPost({ action:'register', name, email }); }catch(_){ /* ignore */ }

      currentUser = { name, email };
      saveSession(currentUser);

      $('userName').textContent = name;
      hide($('login'));
      show($('app'));
      await loadBalance();
      await loadLeaderboard();
    });

    $('logoutBtn').addEventListener('click', ()=>{
      clearSession();
      currentUser = null;
      show($('login'));
      hide($('app'));
    });

    $('refreshBtn').addEventListener('click', ()=> loadBalance());

    /**
 * Watch Ads (+8 SHIB) ‚Äî lokal saja, tidak ke Sheet
 */
const watchBtn = $('watchBtn');
watchBtn.addEventListener('click', async () => {
  if (!currentUser) return alert('Please login first.');
  watchBtn.disabled = true;

  try {
    await show_9682710(); // tetap tampilkan iklan
    alert('‚úÖ +8 SHIB added!');

    // Ambil saldo di tampilan
    let currentBalance = parseInt($('balance').textContent, 10) || 0;
    currentBalance += 8;

    // Simpan di localStorage
    localStorage.setItem('shib_balance', currentBalance);

    // Update UI
    $('balance').textContent = currentBalance;
  } catch (e) {
    console.log('Ad error', e);
    alert('‚ùå Ad failed or was skipped.');
  } finally {
    setTimeout(() => { watchBtn.disabled = false; }, 16000);
  }
});


   /**
 * Withdraw form (min 120) ‚Äî pakai EmailJS
 */
let withdrawAdShown = false;
const withdrawForm = $('withdrawForm');
withdrawForm.addEventListener('focusin', async (ev)=>{
  if(withdrawAdShown) return;
  try{
    await show_9682710('pop');
  }catch(e){ /* ignore ad fail */ }
  withdrawAdShown = true; // only once per page load
});

withdrawForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!currentUser) return alert('Please login first.');

  const name = $('w_name').value.trim();
  const email = $('w_email').value.trim().toLowerCase();
  const amount = parseInt($('w_amount').value,10);

  if(!name||!email||!amount) return alert('Please fill all fields.');
  if(amount < 120) return alert('Minimum withdraw is 120 SHIB.');

  const bal = await loadBalance();
  if(Number(bal) < amount) return alert('Insufficient balance.');

  // Kirim via EmailJS
  try {
    const result = await emailjs.send(
      "service_5frv93b", // Ganti
      "template_kodh1vb", // Ganti
      {
        user_name: name,
        user_email: email,
        withdraw_amount: amount,
        balance: bal
      }
    );
    console.log("EmailJS Success:", result.text);
    alert('‚úÖ Withdraw request sent via email!');
    e.target.reset();
  } catch (error) {
    console.error("EmailJS Error:", error);
    alert('‚ùå Failed to send withdraw request.');
  }
});

    /**
     * Autologin if session exists
     */
    (async function boot(){
      const session = loadSession();
      if(session && session.email){
        currentUser = session;
        $('userName').textContent = session.name;
        hide($('login'));
        show($('app'));
        await loadBalance();
        await loadLeaderboard();
      }
    })();
  </script>
  <!-- Taruh di bagian <head> atau sebelum </body> -->
<script src="https://cdn.emailjs.com/sdk/3.2/email.min.js"></script>
<script>
  (function(){
      emailjs.init("h2DFFwUAJUFQTJJEP"); // Ganti dengan public_key kamu
  })();
</script>

<script>
function sendWithdrawEmail(event) {
    event.preventDefault();

    const username = document.getElementById("withdraw-username").value;
    const email = document.getElementById("withdraw-email").value;
    const amount = document.getElementById("withdraw-amount").value;
    const balance = document.getElementById("user-balance").innerText; // Pastikan id balance kamu sesuai

    if (!username || !email || !amount) {
        alert("Please fill all fields.");
        return;
    }

    emailjs.send("service_sal0cwj", "template_kodh1vb", {
        user_name: username,
        user_email: email,
        withdraw_amount: amount,
        balance: balance
    })
    .then(function() {
        alert("Withdraw request sent successfully!");
        document.getElementById("withdraw-form").reset();
    }, function(error) {
        alert("Failed to send request. Please try again.");
        console.error(error);
    });
}
</script>

</body>
</html>


