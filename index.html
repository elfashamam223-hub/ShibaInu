<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Shiba Inu Airdrop Rewards</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Monetag Ad SDK -->
<script src='//libtl.com/sdk.js' data-zone='9682710' data-sdk='show_9682710'></script>

<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #ffcc70, #ff9966);
    color: #fff;
    text-align: center;
    margin: 0; padding: 0;
  }
  .balance { font-size: 20px; margin: 20px 0; }
  input, button { font-size: 16px; padding: 10px; margin: 5px 0; width: 90%; border-radius: 8px; border: none; }
  button { background: #ff4d4d; color: #fff; cursor: pointer; }
  button:hover { background: #ff3333; }
</style>
</head>
<body>

<h1>Shiba Inu Rewards</h1>
<div class="balance">Balance: <span id="balance">0</span> SHIB</div>

<input type="text" id="username" placeholder="Telegram Username" />
<input type="email" id="email" placeholder="Binance Email" />
<input type="number" id="amount" placeholder="Amount to withdraw (min 120 SHIB)" />

<button id="watchAdBtn">ðŸŽ¥ Watch Ad (+8 SHIB)</button>
<button id="withdrawBtn">ðŸ’¸ Withdraw</button>

<div id="message" style="margin-top:20px; color:#fff;"></div>

<script>
  const webAppUrl = 'https://script.google.com/macros/s/AKfycbx9h-IHEFZ7zyVOcxTyxGRqXImbM13bxhC0-xCpVwoihfDmo53Af_DAsS8inAtil3Iy/exec'; // Ganti ini dengan URL Web App Apps Script Anda

  let balance = 0;

  function setBalanceUI(val) {
    balance = val;
    document.getElementById('balance').innerText = balance;
    localStorage.setItem('shib_balance', balance);
  }

  function loadLocalBalance() {
    const stored = localStorage.getItem('shib_balance');
    if(stored) setBalanceUI(parseInt(stored));
  }

  async function loadUserData() {
    // Ambil user_id dari URL param
    const params = new URLSearchParams(window.location.search);
    const userId = params.get('user_id');
    if(!userId) return;

    try {
      const res = await fetch(`${webAppUrl}?action=get_user&user_id=${userId}`);
      const data = await res.json();
      if(data.status === 'success' && data.user) {
        if(data.user.username) document.getElementById('username').value = data.user.username;
        if(data.user.email) document.getElementById('email').value = data.user.email;
        setBalanceUI(parseInt(data.user.balance || 0));
      }
    } catch(e) {
      console.error('loadUserData error', e);
    }
  }

  async function rewardShib(amount) {
    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();

    if(!username || !email) {
      alert('Please fill your Telegram username and Binance email first.');
      return;
    }

    try {
      const res = await fetch(webAppUrl, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          action: 'update_balance',
          username: username,
          amount: amount
        })
      });

      if(!res.ok) throw new Error(`Server error ${res.status}`);

      const data = await res.json();

      if(data.status === 'success') {
        setBalanceUI(balance + amount);
        alert(`ðŸŽ‰ You earned +${amount} SHIB!`);
      } else {
        alert(`Failed to add balance: ${data.message || 'Unknown error'}`);
      }
    } catch(err) {
      alert('Failed to update balance, please try again later.');
      console.error('rewardShib error:', err);
    }
  }

  async function withdraw() {
    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();
    const amountInput = document.getElementById('amount').value.trim();
    const amount = parseInt(amountInput);

    if(!username || !email) {
      alert('Please fill your Telegram username and Binance email first.');
      return;
    }
    if(isNaN(amount) || amount < 120) {
      alert('Minimum withdraw is 120 SHIB');
      return;
    }
    if(amount > balance) {
      alert('Insufficient balance.');
      return;
    }

    try {
      const res = await fetch(webAppUrl, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          action: 'submit_withdraw',
          username: username,
          email: email,
          amount: amount
        })
      });

      if(!res.ok) throw new Error(`Server error ${res.status}`);

      const data = await res.json();

      if(data.status === 'success') {
        alert('âœ… Withdraw submitted successfully!');
        setBalanceUI(balance - amount);
        document.getElementById('amount').value = '';
      } else {
        alert(`Withdraw failed: ${data.message || 'Unknown error'}`);
      }
    } catch(err) {
      alert('Failed to submit withdraw.');
      console.error('withdraw error:', err);
    }
  }

  document.getElementById('watchAdBtn').addEventListener('click', () => {
    show_9682710().then(() => {
      rewardShib(8);
    }).catch(() => {
      alert('Ad failed or was skipped.');
    });
  });

  document.getElementById('withdrawBtn').addEventListener('click', withdraw);

  window.onload = () => {
    loadLocalBalance();
    loadUserData();
  }
</script>

</body>
</html>
